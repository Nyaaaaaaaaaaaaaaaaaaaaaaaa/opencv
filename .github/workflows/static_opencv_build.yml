name: Manual Static OpenCV Build & Release

# 允许手动触发工作流
on:
  workflow_dispatch:
    inputs:
      opencv_version:
        description: '要编译的 OpenCV 版本 (e.g., 4.9.0)'
        required: true
        default: '4.9.0'

env:
  OPENCV_VERSION: ${{ github.event.inputs.opencv_version }}
  INSTALL_DIR: ${{ github.workspace }}/opencv_static_install

jobs:
  build-linux-static:
    runs-on: ubuntu-latest
    
    # === 关键修复：添加写入权限 ===
    permissions:
      contents: write # 允许 GITHUB_TOKEN 创建 Releases 和 Tags
    # ==========================
    
    steps:
      - name: Checkout OpenCV Source Code
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv
          ref: ${{ env.OPENCV_VERSION }} 

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libssl-dev libtbb-dev

      - name: Configure CMake for Static Build
        run: |
          mkdir build
          cd build
          cmake .. \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_js=OFF \
            -DWITH_QT=OFF \
            -DWITH_GTK=OFF \
            -DWITH_V4L=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }}

      - name: Build and Install OpenCV
        run: |
          cmake --build build -j $(nproc)
          cmake --install build

      - name: Package Static Libraries for Release
        run: |
          cd ${{ env.INSTALL_DIR }}
          ZIP_FILE=opencv-static-${{ env.OPENCV_VERSION }}-linux-x64.zip
          zip -r $ZIP_FILE *
          mv $ZIP_FILE ${{ github.workspace }}/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/opencv-static-${{ env.OPENCV_VERSION }}-linux-x64.zip
          name: OpenCV Static Build ${{ env.OPENCV_VERSION }} (Linux x64)
          tag_name: opencv-static-${{ env.OPENCV_VERSION }} 
          draft: false
          prerelease: false
